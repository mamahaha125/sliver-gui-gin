<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>资源管理</title>
    <link rel="stylesheet" href="/static/component/pear/css/pear.css"/>
    <link rel="stylesheet" href="/static/component/pear/css/module/dtree/dtree.css">
    <link rel="stylesheet" href="/static/component/pear/css/module/dtree/font/dtreefont.css">
    <link rel="stylesheet" href="/static/component/xterm/xterm.css" />
    <script src="/static/component/xterm/xterm.js"></script>
    <meta name="referrer" content="no-referrer"/>
    <style>
        .icon {
            width: 1em;
            height: 1em;
            vertical-align: -0.15em;
            fill: currentColor;
            overflow: hidden;
        }
    </style>
</head>
<body class="pear-container">

<div class="layui-row layui-col-space10">
    <div class="C layui-col-md12">
        <div class="layui-card top-panel">
            <div class="layui-card-header">流量统计</div>
            <div class="layui-card-body">
                <div class="layui-row layui-col-space5">
                    <div id="terminal"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="layui-row layui-col-space10">
    <div class="layui-col-xs6 layui-col-md6">
        <div class="layui-card top-panel">
            <div class="layui-card-header">流量统计</div>
            <div class="layui-card-body">
                <div class="layui-row layui-col-space5">
                    <ul id="demoTree" class="dtree" data-id="0"></ul>
                </div>
            </div>
        </div>
    </div>
    <div class="layui-col-xs6 layui-col-md6">
        <div class="layui-card top-panel">
            <div class="layui-card-header">流量统计</div>
            <div class="layui-card-body">
                <div class="layui-row layui-col-space5">
                    <ul id="demoTree2" class="dtree" data-id="0"></ul>
                </div>
            </div>
        </div>
    </div>
</div>



<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>
<script src="/static/component/pear/css/module/dtree/dtree.js"></script>
<script>
    const term = new Terminal();

    term.open(document.querySelector('#terminal')); // 挂载

    const socket = new WebSocket(`ws://${window.location.host}/shell/websocket`); // 创建WebSocket连接

    term.onData((data) => { // 网页xterm窗口中有输入的数据
        // console.log('term.onData:', data);
        socket.send(data); // 通过WebSocket发送给服务器
    });

    socket.onmessage = (event) => { // 收到来自服务器的WebSocket消息
        // console.log('socket.onmessage:', event.data);
        term.write(event.data); // 向xterm对象写入数据
    };


    function mouseright(dom) {
        var dropdown = layui.dropdown;
        var util = layui.util;
        // 右键菜单
        dropdown.render({
            elem: '#' + dom, // 也可绑定到 document，从而重置整个右键
            trigger: 'contextmenu', // contextmenu
            isAllowSpread: false, // 禁止菜单组展开收缩
            style: 'width: 200px', // 定义宽度，默认自适应
            data: [{
                title: '打开',
                id: 'test'
            }, {
                title: '下载',
                id: 'print'
            },{
                title: '复制',
                id: 'reload'
            },{type:'-'},{
                title: 'menu item 3',
                id: '#3',
                child: [{
                    title: 'menu item 3-1',
                    id: '#1'
                },{
                    title: 'menu item 3-2',
                    id: '#2'
                },{
                    title: 'menu item 3-3',
                    id: '#3'
                }]
            },
                {type: '-'},
                {
                    title: '剪切',
                    id: ''
                },{
                    title: '修改权限',
                    id: '#1'
                },{
                    title: '删除',
                    id: '#1'
                },{
                    title: '属性',
                    id: '#1'
                }],
            click: function(obj, othis){
                if(obj.id === 'test'){
                    layer.msg('click');
                } else if(obj.id === 'print'){
                    window.print();
                } else if(obj.id === 'reload'){
                    location.reload();
                }
            }
        });
        // 其他操作
        util.event('lay-on', {
            // 全局右键菜单
            contextmenu: function(othis){
                var ID = 'ID-dropdown-demo-contextmenu';
                if(!othis.data('open')){
                    dropdown.reload(ID, {
                        elem: document // 将事件直接绑定到 document
                    });
                    layer.msg('已开启全局右键菜单，请尝试在页面任意处单击右键。')
                    othis.html('取消全局右键菜单');
                    othis.data('open', true);
                } else {
                    dropdown.reload(ID, {
                        elem: '#'+ ID // 重新绑定到指定元素上
                    });
                    layer.msg('已取消全局右键菜单，恢复默认右键菜单')
                    othis.html('开启全局右键菜单');
                    othis.data('open', false);
                }
            }
        });
    }

    layui.extend({
        dtree: '{/}layui_ext/dtree/dtree'   // {/}的意思即代表采用自有路径，即不跟随 base 路径
    }).use(['dtree','layer','jquery'], function(){
        var dtree = layui.dtree, layer = layui.layer, $ = layui.jquery;
        // 初始化树
        var Path
        var tmps
        var DemoTree = dtree.render({
            elem: "#demoTree",
            // data: , // 使用data加载
            dataStyle: "layuiStyle",
            url: "/shell/file", // 使用url加载（可与data加载同时存在）
            request: {"path": tmps},
            record: true,
            ficon: "-1",  // 隐藏一级图标
            menubar:true,
            menubarTips: {
                group:["refresh", {
                    menubarId: "extGroupId1",  // 按钮的唯一ID
                    icon: "dtree-icon-homefill", // 从dtreefont库中选取
                    title: "自定义按钮1",  // 按钮的提示标题
                    handler: function(node, $div){  //扩展按钮的回调函数
                        if (tmps == null) {
                            tmps = "."
                        }
                        dtree.reload("demoTree",{
                            url: "/shell/file/back",
                            request: {"path": tmps},
                            complete: function(XMLHttpRequest, textStatus){ //异步加载完成时回调
                                tmps = XMLHttpRequest.responseJSON.msg
                                term.write(XMLHttpRequest.responseJSON.msg)
                            }
                        });

                    }
                }]
            },
            complete: function(XMLHttpRequest, textStatus){ //异步加载完成时回调
                tmps = XMLHttpRequest.responseJSON.msg
            }
        });

        var DemoTree2 = dtree.render({
            elem: "#demoTree2",
            // data: , // 使用data加载
            dataStyle: "layuiStyle",
            url: "/shell/ps", // 使用url加载（可与data加载同时存在）
            record: true,
            ficon: "-1",  // 隐藏一级图标
            menubar: true,
            menubarTips: {
                group: ["refresh"]
            },
            complete: function () {
                mouseright("demoTree2")
            }
        })

        // 绑定节点点击
        dtree.on("node('demoTree')" ,function(obj){
            layer.msg(JSON.stringify(obj.param.recordData));
            tmps = obj.param.recordData.path;
            console.log(tmps)
            dtree.render({
                elem: "#demoTree",
                // data: , // 使用data加载
                dataStyle: "layuiStyle",

                url: "/shell/file",
                request: {"path": tmps},
                record: true,
                ficon: "-1",  // 隐藏一级图标
                menubar:true,
                menubarTips: {
                    group:["refresh", {
                        menubarId: "extGroupId1",  // 按钮的唯一ID
                        icon: "dtree-icon-homefill", // 从dtreefont库中选取
                        title: "自定义按钮1",  // 按钮的提示标题
                        handler: function(node, $div){  //扩展按钮的回调函数
                            if (tmps == null) {
                                tmps = "."
                            }
                            dtree.reload("demoTree",{
                                url: "/shell/file/back",
                                request: {"path": tmps},
                                complete: function(XMLHttpRequest, textStatus){ //异步加载完成时回调
                                    tmps = XMLHttpRequest.responseJSON.msg
                                    mouseright("demoTree")
                                }
                            });
                        }
                    }]
                },
                complete: function(XMLHttpRequest, textStatus){ //异步加载完成时回调
                    tmps = XMLHttpRequest.responseJSON.msg
                    mouseright("demoTree")
                },
            });

        });
    });

    // layui.extend({
    //     dtree: '{/}layui_ext/dtree/dtree'   // {/}的意思即代表采用自有路径，即不跟随 base 路径
    // }).use(['dtree','layer','jquery'], function(){
    //     var dtree = layui.dtree, layer = layui.layer, $ = layui.jquery;
    //     // 初始化树
    //     var Path
    //     var tmps
    //     var DemoTree2 = dtree.render({
    //         elem: "#demoTree2",
    //         // data: , // 使用data加载
    //         dataStyle: "layuiStyle",
    //         url: "/shell/ps", // 使用url加载（可与data加载同时存在）
    //         record: true,
    //         ficon: "-1",  // 隐藏一级图标
    //         menubar:true,
    //         menubarTips: {
    //             group:["refresh"]
    //         },
    //         complete: function () {
    //             mouseright("demoTree2")
    //         }
    //     });
    // });

</script>

</body>

</html>